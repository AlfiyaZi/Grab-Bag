#! /bin/python

import shlex, os, time, subprocess, serial, sqlite3


cmd = "mplayer -idle -fixed-vo -framedrop -quiet -slave -fs -zoom -x 760 -y 600 /home/nycr/Video/main.mov"
args = shlex.split(cmd)

port1 = '/dev/ttyUSB0'

def playVid():
	print "Playing new Video"

	print "Playing 3"
	cmd = "loadfile /home/nycr/Video/3.mov\n"
	p.stdin.write(cmd)

def makeDrink(args):
	drinkString = {}

	for x in args:
		drinkString += drinks[x]
	print drinkString

def receiving(ser):
	global last_received
	print "receiving"
	buffer = ''
	while True:
		buffer = buffer + ser.read(ser.inWaiting())
		#print "BUFFER: ", buffer
		
		if '\n' in buffer:
			print "Found linebreak"
			lines = buffer.split('\n')
			last_received = lines[-2]
			buffer = lines[-1]
			print last_received
			
			if "SPIN RESULT" in last_received:
				spinArgs = last_received.split(" ")
				print "DRINK 1: " + spinArgs[2]
				print "DRINK 2: " + spinArgs[3]
				print "DRINK 3: " + spinArgs[4]
				drinkArgs = spinArgs[2:]
				makeDrink(drinkArgs)
			#if "spin" in last_received:
				playVid()
		time.sleep(.25)
while True:
	print "Waiting..."	

	#input = ser.readline(size=None, eol='\n')
	#print input
	#ser.flushInput()
	receiving(ser)



if '__name__' == '__main__':
	print "Starting up..."
	
	try:
		ser = serial.Serial(port1, 9600, timeout=.1)
		ser.open()
	except:
		print "Could not open " + port1
		sys.exit(-1)
		
	if ser.isOpen() is True:	
		p = subprocess.Popen(args, stdin=subprocess.PIPE, stdout=subprocess.PIPE)
		time.sleep(3)
		ser.flushInput()
	else:
		print "Could not open " + port1
		sys.exit(-1)

